<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server - Everyday Linux</title>
<meta name="author" content="Everyday Linux">
<meta name="description" content="Examples of working solutions in everyday Linux.">

<meta name="generator" content="Hugo 0.55.6" />


<link href="//fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
<link rel="stylesheet" href='/assets/css/main.6c6783c882af.css'>


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon.png">
<link rel="shortcut icon" href="/assets/img/favicon.ico">


<link href="/posts/index.xml" rel="alternate" type="application/rss+xml" title="Everyday Linux" />
<link href="/posts/index.xml" rel="feed" type="application/rss+xml" title="Everyday Linux" />

<meta property="og:title" content="RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server" />
<meta property="og:description" content="RH-SSO server install. This can be done with yum/rpm or zip. Using zips allows you to leverage more middleware services on one VM/box. $ unzip rh-sso-7.2.0.GA.zip $ cd rh-sso-7.2/bin $ ./add-user-keycloak.sh -u admin -p admin     EAP server install. $ jboss-eap-7.1.0.zip $ cd jboss-eap-7.1 $ unzip rh-sso-7.2.0.GA-eap7-adapter.zip -d jboss-eap-7.1 $ unzip -o rh-sso-7.2.0.GA-saml-eap7-adapter.zip -d jboss-eap-7.1 $ cd bin $ ./standalone.sh &amp; ENTER $ ./jboss-cli.sh -c --file=adapter-install.cli $ ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://briantward.github.io/rh-sso-on-rhel7/" />
<meta property="article:published_time" content="2018-05-01T12:00:00-04:00"/>
<meta property="article:modified_time" content="2018-05-01T12:00:00-04:00"/>



<meta itemprop="name" content="RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server">
<meta itemprop="description" content="RH-SSO server install. This can be done with yum/rpm or zip. Using zips allows you to leverage more middleware services on one VM/box. $ unzip rh-sso-7.2.0.GA.zip $ cd rh-sso-7.2/bin $ ./add-user-keycloak.sh -u admin -p admin     EAP server install. $ jboss-eap-7.1.0.zip $ cd jboss-eap-7.1 $ unzip rh-sso-7.2.0.GA-eap7-adapter.zip -d jboss-eap-7.1 $ unzip -o rh-sso-7.2.0.GA-saml-eap7-adapter.zip -d jboss-eap-7.1 $ cd bin $ ./standalone.sh &amp; ENTER $ ./jboss-cli.sh -c --file=adapter-install.cli $ .">


<meta itemprop="datePublished" content="2018-05-01T12:00:00-04:00" />
<meta itemprop="dateModified" content="2018-05-01T12:00:00-04:00" />
<meta itemprop="wordCount" content="587">



<meta itemprop="keywords" content="sso,rh-sso,keycloak,authentication,authorization," />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server"/>
<meta name="twitter:description" content="RH-SSO server install. This can be done with yum/rpm or zip. Using zips allows you to leverage more middleware services on one VM/box. $ unzip rh-sso-7.2.0.GA.zip $ cd rh-sso-7.2/bin $ ./add-user-keycloak.sh -u admin -p admin     EAP server install. $ jboss-eap-7.1.0.zip $ cd jboss-eap-7.1 $ unzip rh-sso-7.2.0.GA-eap7-adapter.zip -d jboss-eap-7.1 $ unzip -o rh-sso-7.2.0.GA-saml-eap7-adapter.zip -d jboss-eap-7.1 $ cd bin $ ./standalone.sh &amp; ENTER $ ./jboss-cli.sh -c --file=adapter-install.cli $ ."/>


  </head>
  <body>
    <nav>
  <div class="title">
    
      <a href="/" title="Homepage">
        Everyday Linux
      </a>
    
  </div>
  <div class="nav">
    
      <a href="/" title="Homepage">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <polyline points="9 22 9 12 15 12 15 22" />
        </svg>
      </a>
    
    <a href="/posts/index.xml" title="RSS">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="rss"
      >
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
  </div>
</nav>

    <main>
      
  <article>
    <header>
      <p>
        <time datetime="2018-05-01 12:00">2018-05-01</time> &bull;
          
            
            <a href="/categories/middleware">MIDDLEWARE</a>
          </p>
      <h1>RH-SSO 7.2 on Red Hat Enterprise Linux 7.5 integrated with Identity Management or Directory Server</h1>
      <p>
        
          
            
            <a href="/tags/sso">
              <span class="hash">#</span>sso</a>
          
            , 
            <a href="/tags/rh-sso">
              <span class="hash">#</span>rh-sso</a>
          
            , 
            <a href="/tags/keycloak">
              <span class="hash">#</span>keycloak</a>
          
            , 
            <a href="/tags/authentication">
              <span class="hash">#</span>authentication</a>
          
            , 
            <a href="/tags/authorization">
              <span class="hash">#</span>authorization</a>
          
        
      </p>
    </header>
    <section>
      
<div class="sect1">
<h2 id="_rh_sso_server_install_this_can_be_done_with_yumrpm_or_zip_using_zips_allows_you_to_leverage_more_middleware_services_on_one_vmbox">RH-SSO server install.  This can be done with yum/rpm or zip.  Using zips allows you to leverage more middleware services on one VM/box.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ unzip rh-sso-7.2.0.GA.zip
$ cd rh-sso-7.2/bin
$ ./add-user-keycloak.sh -u admin -p admin</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_eap_server_install">EAP server install.</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ jboss-eap-7.1.0.zip
$ cd jboss-eap-7.1
$ unzip rh-sso-7.2.0.GA-eap7-adapter.zip -d jboss-eap-7.1
$ unzip -o rh-sso-7.2.0.GA-saml-eap7-adapter.zip -d jboss-eap-7.1
$ cd bin
$ ./standalone.sh &amp;
 ENTER
$ ./jboss-cli.sh -c --file=adapter-install.cli
$ ./jboss-cli.sh -c --file=adapter-install-saml.cli
$ fg 1
 CTRL+C</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_certificates_for_the_rh_sso_server">Create certificates for the RH-SSO server:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Create the base keystore using java keytool.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -genkeypair -alias pki-sso -keyalg RSA -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -storepass password --keypass password --dname "CN=host.example.com,O=OU.EXAMPLE.COM"</pre>
</div>
</div>
</li>
<li>
<p>Create the certificate in PEM format from the keystore using the java keytool.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -exportcert  -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -alias pki-sso -keypass password -storepass password -file /opt/rh-sso-7.2/standalone/configuration/pki-sso.cer</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_certificates_for_the_eap_app_server">Create certificates for the EAP-APP server:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Create the base keystore using java keytool.  Alternatively, on the first server startup one is generated by default and you can use that one.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -genkeypair -alias eap-app -keyalg RSA -keystore /opt/rh-sso-7.2/standalone/configuration/eap-app.jks -storepass password --keypass password --dname "CN=host.example.com,O=OU.EXAMPLE.COM"</pre>
</div>
</div>
</li>
<li>
<p>Create the certificate in PEM format from the keystore using the java keytool.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -exportcert  -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-app.jks -alias eap-app -keypass password -storepass password -file /opt/jboss-eap-7.1/standalone/configuration/eap-app.cer</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_import_opposing_certificates_into_each_servers_truststore_this_one_line_command_automatically_creates_the_truststore_and_imports_the_certificate_at_the_same_time">Import opposing certificates into each server&#8217;s truststore.  This one line command automatically creates the truststore and imports the certificate at the same time.</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Import the EAP certificate into the RH-SSO truststore.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -import -file /opt/jboss-eap-7.1/standalone/configuration/eap-app.cer -alias eap-app -keystore /opt/rh-sso-7.2/standalone/configuration/sso-trust.jks -keypass password -storepass password</pre>
</div>
</div>
</li>
<li>
<p>Import the RH-SSO certificate into the EAP truststore.</p>
<div class="literalblock">
<div class="content">
<pre>$ keytool -import -file /opt/rh-sso-7.2/standalone/configuration/pki-sso.cer -alias pki-sso -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-trust.jks -keypass password -storepass password</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_review_all_java_keystores">Review all Java Keystores:</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ keytool -list -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-trust.jks -keypass password -storepass password
$ keytool -list -keystore /opt/jboss-eap-7.1/standalone/configuration/eap-app.jks -keypass password -storepass password
$ keytool -list -keystore /opt/rh-sso-7.2/standalone/configuration/sso-trust.jks -keypass password -storepass password
$ keytool -list -keystore /opt/rh-sso-7.2/standalone/configuration/pki-sso.jks -keypass password -storepass password</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_edit_the_servers_to_use_the_keystores_and_truststores">Edit the servers to use the keystores and truststores.</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Edit the RH-SSO standalone.xml:</p>
<div class="literalblock">
<div class="content">
<pre>&lt;security-realm name="ApplicationRealm"&gt;
     &lt;server-identities&gt;
         &lt;ssl&gt;
             &lt;keystore path="pki-sso.jks" relative-to="jboss.server.config.dir" keystore-password="password" alias="pki-sso" key-password="password"/&gt;
         &lt;/ssl&gt;
     &lt;/server-identities&gt;
     &lt;authentication&gt;
         &lt;local default-user="$local" allowed-users="*" skip-group-loading="true"/&gt;
         &lt;properties path="application-users.properties" relative-to="jboss.server.config.dir"/&gt;
         &lt;truststore path="sso-trust.jks" relative-to="jboss.server.config.dir" keystore-password="password"/&gt;
     &lt;/authentication&gt;
     &lt;authorization&gt;
         &lt;properties path="application-roles.properties" relative-to="jboss.server.config.dir"/&gt;
     &lt;/authorization&gt;
 &lt;/security-realm&gt;</pre>
</div>
</div>
</li>
<li>
<p>Edit the EAP-APP standalone.xml:</p>
<div class="literalblock">
<div class="content">
<pre>&lt;system-properties&gt;
    &lt;property name="javax.net.ssl.trustStorePassword" value="password"/&gt;
    &lt;property name="javax.net.ssl.trustStore" value="${jboss.server.config.dir}/eap-trust.jks"/&gt;
&lt;/system-properties&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;security-realm name="ApplicationRealm"&gt;
    &lt;server-identities&gt;
        &lt;ssl&gt;
            &lt;keystore path="eap-app.jks" relative-to="jboss.server.config.dir" keystore-password="password" alias="eap-app" key-password="password"/&gt;
        &lt;/ssl&gt;
    &lt;/server-identities&gt;
    &lt;authentication&gt;
        &lt;truststore path="eap-app.jks" relative-to="jboss.server.config.dir" keystore-password="password"/&gt;
    &lt;/authentication&gt;
    &lt;authorization&gt;
        &lt;properties path="application-roles.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/authorization&gt;
&lt;/security-realm&gt;</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_the_servers_and_verify_the_configurations">Run the servers and verify the configurations:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Run RH-SSO with debug and tech preview profiles for Fine-Grained Authentication management</p>
<div class="literalblock">
<div class="content">
<pre>/opt/rh-sso-7.2/bin/standalone.sh -Dkeycloak.profile=preview -Dsun.security.krb5.debug=true -Dsun.security.spnego.debug=true -b 0.0.0.0 &amp;</pre>
</div>
</div>
</li>
<li>
<p>Run EAP-APP with a port offset on the sockets to prevent conflict with the RH-SSO server</p>
<div class="literalblock">
<div class="content">
<pre>/opt/jboss-eap-7.1/bin/standalone.sh -b 0.0.0.0 -Djboss.socket.binding.port-offset=1000 -Djavax.net.debug=all &amp;</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_a_test_app_for_the_eap_app_server">Build a test app for the EAP-APP server</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Clone the keycloak quickstarts.  Use community because it appears the RH-SSO quickstarts are not up-to-date.</p>
<div class="literalblock">
<div class="content">
<pre>$ git clone git@github.com:keycloak/keycloak-quickstarts.git
$ cd keycloak-quickstarts
$ git checkout 3.4.3-Final
$ cd app-profile-jee-jsp
remove line '&lt;file&gt;${basedir}/config/keycloak.json&lt;/file&gt;' from pom.xml
$ mvn clean package -DskipTests
$ cp target/app-profile-jsp.war $EAP-APP_HOME/standalone/deployments</pre>
</div>
</div>
</li>
<li>
<p>Add a client in the RH-SSO server.</p>
<div class="literalblock">
<div class="content">
<pre>TODO: add GUI steps to do this.</pre>
</div>
</div>
</li>
<li>
<p>Add the keycloak deployment configuration for an OIDC app.</p>
<div class="literalblock">
<div class="content">
<pre>&lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
    &lt;secure-deployment name="app-profile-jsp.war"&gt;
        &lt;realm&gt;hackathon&lt;/realm&gt;
        &lt;auth-server-url&gt;https://host.example.com:8443/auth&lt;/auth-server-url&gt;
        &lt;public-client&gt;true&lt;/public-client&gt;
        &lt;ssl-required&gt;EXTERNAL&lt;/ssl-required&gt;
        &lt;resource&gt;app-profile-jsp&lt;/resource&gt;
    &lt;/secure-deployment&gt;
&lt;/subsystem&gt;</pre>
</div>
</div>
</li>
<li>
<p>Add the keycloak deployment configuration for a SAML app.</p>
<div class="literalblock">
<div class="content">
<pre>&lt;subsystem xmlns="urn:jboss:domain:keycloak-saml:1.1"&gt;
    &lt;secure-deployment name="app-profile-saml.war"&gt;
        &lt;SP entityID="app-profile-saml"
            sslPolicy="EXTERNAL"
            logoutPage="/index.jsp"&gt;
            &lt;Keys&gt;
                &lt;Key signing="true"&gt;
                    &lt;PrivateKeyPem&gt;&lt;/PrivateKeyPem&gt;
                    &lt;CertificatePem&gt;&lt;/CertificatePem&gt;
                &lt;/Key&gt;
            &lt;/Keys&gt;
            &lt;IDP entityID="idp"
                 signatureAlgorithm="RSA_SHA256"
                 signatureCanonicalizationMethod="http://www.w3.org/2001/10/xml-exc-c14n#"&gt;
                &lt;SingleSignOnService signRequest="true"
                                     validateResponseSignature="true"
                                     validateAssertionSignature="false"
                                     requestBinding="POST"
                                     bindingUrl="https://host.example.com:8443/auth/realms/hackathon/protocol/saml"/&gt;
                &lt;SingleLogoutService signRequest="true"
                                     signResponse="true"
                                     validateRequestSignature="true"
                                     validateResponseSignature="true"
                                     requestBinding="POST"
                                     responseBinding="POST"
                                     postBindingUrl="https://host.example.com:8443/auth/realms/hackathon/protocol/saml"
                                     redirectBindingUrl="https://host.example.com:8443/auth/realms/hackathon/protocol/saml"/&gt;
            &lt;/IDP&gt;
        &lt;/SP&gt;
    &lt;/secure-deployment&gt;
&lt;/subsystem&gt;</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_rh_sso_to_federate_with_ldap">Set up RH-SSO to federate with LDAP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO add GUI steps to do this.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ldap://idm.example.com</p>
</li>
<li>
<p>cn=users,cn=accounts,dc=idm,dc=example,dc=com</p>
</li>
<li>
<p>CN=Directory Manager</p>
</li>
<li>
<p>Pa55word</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other">Other</h2>
<div class="sectionbody">
<div class="paragraph">
<p>signing cert with IPA&#8230;&#8203;</p>
</div>
</div>
</div>
</section>
    <footer>
      
      
    </footer>
  </article>

    </main>
    <footer>
  <div class="powered-by">
    Powered by <a href="https://gohugo.io" title="A Fast and Flexible Website Generator">Hugo</a> &amp; <a href="https://github.com/eshlox/simplicity" title="Hugo theme">Simplicity</a>.
  </div>
  <div class="copyright">
    &copy; 2019 Everyday Linux. <a href="http://creativecommons.org/licenses/by-sa/4.0/">Some Rights Reserved</a>.
  </div>
</footer>

    <script src="/assets/js/main.28b0c18ba028.js"></script>
    
    
  </body>
</html>
